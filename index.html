<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Dashboard</title>

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,500,500i,700&amp;subset=cyrillic,greek" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/normalize.css" type="text/css">
    <link rel="stylesheet" href="css/skeleton.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">

    <script src="js/jquery-3.2.1.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>
<body>
<script>
    window.fbAsyncInit = function() {
        FB.init({
            appId            : '340229343095066',
            autoLogAppEvents : true,
            xfbml            : true,
            version          : 'v2.10'
        });
        FB.AppEvents.logPageView();
        FB.Event.subscribe('auth.statusChange', function(response) {
            FB.getLoginStatus(function(response) {
                if (response.status === 'connected') {

                    var token = response.authResponse.accessToken;
                    loadHomepage(true, token);

                } else { loadHomepage(false); }
            });
        });
    };

    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    } (document, 'script', 'facebook-jssdk'));
</script>


<div id="fb-login-section" class="section hero">
    <div class="container">
        <div class="row">
            <div class="twelve columns">
                <h4>Please login with Facebook to proceed</h4>
                <br>
                <div role="button" class="fb-login-button"  data-max-rows="1" data-size="large" data-button-type="continue_with" data-show-faces="false" data-auto-logout-link="false" data-use-continue-as="false"></div>
                <br>
                <div class="whitespace-separator"><button id="noFbBtn" class="button"> Continue without Facebook</button></div>
            </div>
        </div>



    </div>
</div>

<div class="whitespace-separator"></div>

<div id="loader" class="loading-wrapper" style="display: none;">
    <div class="loader">
        <h5>Loading Dashboard</h5>
        <div class="bar"></div>
    </div>
</div>

<div id="homepage-section" style="display: none;">
    <div class="container">
        <div class="row">

            <div class="two columns">
                <button class="interface-btn">
                    <i class="material-icons text-XL">help</i>
                    <span class="text-MD">HELP</span>
                </button>
                <p class="align-text-center text-caption">Contact us if you need help</p>
            </div>

            <div class="two columns">
                <button class="interface-btn">
                    <i class="material-icons text-XL">person</i>
                    <span class="text-MD">PROFILE</span>
                </button>
                <p class="align-text-center text-caption">Edit your information</p>
            </div>

            <div class="two columns">
                <button class="interface-btn" id="trainingBtn">
                    <i class="material-icons text-XL">desktop_windows</i>
                    <span class="text-MD">TRAINING</span>
                </button>
                <p class="align-text-center text-caption">Replay the training app to score better</p>
            </div>
            <div class="two columns">
                <div class="row">Basic: <div id="basic1Indicator" class="circle"></div>&nbsp;<div id="basic2Indicator" class="circle"></div></div>
                <br>
                <span class="row">Int: <span id="int1Indicator" class="circle"></span>&nbsp;<span id="int2Indicator" class="circle"></span>&nbsp;<span id="int3Indicator" class="circle"></span></span>
                <br>
                <span class="row">Adv: <span id="adv1Indicator" class="circle"></span>&nbsp;<span id="adv2Indicator" class="circle"></span>&nbsp;<span id="adv3Indicator" class="circle"></span>&nbsp<span id="adv4Indicator" class="circle"></span></span>
                <br>
                <p class="align-text-center text-caption">Training status</p>
            </div>

            <div class="two columns">

                <br>
                <div class="row align-text-center">
                    <div class="four columns"><i class="material-icons">people</i></div>
                    <div class="four columns"><i class="material-icons">mood</i></div>
                    <div class="four columns"><i class="material-icons">school</i></div>
                </div>
                <hr>
                <div id="table-content">
                    <div class="row align-text-center">
                        <div class="four columns"><span id="scoreAverageParticipationIndicator">0.0</span></div>
                        <div class="four columns"><span id="scoreAverageEmpowermentIndicator">0.0</span></div>
                        <div class="four columns"><span id="scoreAverageEducationIndicator">0.0</span></div>
                    </div>
                </div>
                <br>
                <p class="align-text-center text-caption">Score summary</p>
            </div>

            <div class="two columns">
                <span id="interfaceUsername" class="u-pull-right">Put username here</span>
                <br>
                <span class="u-pull-right">Total score</span>
                <br>
                <span class="u-pull-right"><b id="scoreTotalIndicator">6.0</b></span>
            </div>
        </div>
    </div>

    <div class="whitespace-separator"></div>

    <div class="container">
        <div class="row content-style">

            <div class="twelve columns">

                <div class="six columns">
                    <button class="tab-btn tab-btn-active" id="detailsPanelBtn">
                        <span class="text-LG">DETAILS</span>
                        <span class="text-SM align-text-center">See how you can improve</span>
                    </button>
                </div>
                <div class="six columns">
                    <button class="tab-btn tab-btn-inactive" id="graphPanelBtn">
                        <span class="text-LG">GRAPHS</span>
                        <span class="text-SM align-text-center">See how well you perform over time</span>
                    </button>
                </div>
            </div>

            <div class="twelve columns details-panel-style">

                <div id="detailsPanel">

                    <div class="twelve columns">
                        <h5 class="section-heading">How to get better</h5>

                        <div class="row">
                            <div class="four columns text-white">
                                <i class="material-icons text-LG" style="vertical-align: bottom">people</i>
                                <span class="text-MD">Participation & Social</span>
                                <span class="progress-bar"><progress id="participationProgressBar" value="50" max="100"></progress></span>
                                <hr>
                                <p> 1. E-mail </p>
                                <p> 2. General social network activity </p>
                                <p>&nbsp; 2a. Facebook </p>
                                <p>&nbsp; 2b. Twitter </p>
                                <p> 3. Participation in fora </p>
                                <p> 4. Time spent online </p>
                                <p> 5. Keyboard typing </p>
                                <br>
                            </div>

                            <div class="four columns text-white">
                                <i class="material-icons text-LG" style="vertical-align: bottom">mood</i>
                                <span class="text-MD">Empowerment & Wellbeing</span>
                                <span class="progress-bar"><progress id="empowermentProgressBar" value="25" max="100"></progress></span>
                                <hr>
                                <p> 1. Gaming (X) </p>
                                <p> 2. Entertainment (YouTube) </p>
                                <p> 3. Health-related resources </p>
                                <p> 4. Reading news </p>
                                <p> 5. Time spent online </p>
                                <br>
                            </div>

                            <div class="four columns text-white">
                                <i class="material-icons text-LG" style="vertical-align: bottom">school</i>
                                <span class="text-MD">Education & Employment</span>
                                <span class="progress-bar"><progress id="educationProgressBar" value="80" max="100"></progress></span>
                                <hr>
                                <p> 1. E-learning resources </p>
                                <p> 2. Professional networks </p>
                                <p> 3. Personal business website </p>
                                <p> 4. Client & job search </p>
                                <p> 5. Online work tools (X) </p>
                                <br>

                            </div>
                        </div>
                    </div>

                </div>


                <div id="graphPanel" style="display: none">
                    <div id="chart"></div>
                </div>
            </div>


        </div>

    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
<script type="text/javascript" src="js/callback.js"></script>
<script type="text/javascript">

    google.charts.load('current', {'packages':['corechart', 'line']});

    // Initialize Firebase
    // TODO get apiKey & projectId information from GTW (along with email & password)
    var config = {
        apiKey: "AIzaSyBMa9gSXsoDo27S7P959QZYf3rJBGDGEIA",
        projectId: "mamem-phase2-fall17"
    };
    config.authDomain = config.projectId + ".firebaseapp.com";
    config.databaseURL = "https://" + config.projectId + ".firebaseio.com";
    config.storageBucket = config.projectId + ".appspot.com";

    firebase.initializeApp(config);

    // Set global vars
    var initializationCallback;
    var currentUser;
    var user = [];
    user.details = [];
    user.socialTracker = [];
    user.FB = [];
    user.FB.data = [];
    user.ST = [];
    user.ST.sources = 0;
    user.hasFB = false;
    user.hasST = false;

    // Get information from firebase
    var currentUrl = window.location.href;

    var url = new URL(window.location.href);
    user.details.email = url.searchParams.get("email");
    user.details.password = url.searchParams.get("pass");

    console.log(user);

    firebase.auth().signInWithEmailAndPassword(user.details.email, user.details.password).then(function() {

        var currentUser =  firebase.auth().currentUser;
        if (currentUser != null) {

            return firebase.database().ref('/users/' + currentUser.uid).once('value').then(function(snapshot) {

                user.details.nickname = snapshot.val().userDetails.nickname;
                user.details.gender = snapshot.val().userDetails.gender;
                user.details.age = snapshot.val().userDetails.age;
                user.details.firstName = snapshot.val().userDetails.firstName;
                user.details.language = snapshot.val().userDetails.lang;
                user.details.quizTranslation = snapshot.val().userDetails.quizTranslation;
                user.hasST = snapshot.val().userDetails.socialTracker;
                user.ST.collection = snapshot.val().userDetails.stCollectionName;

                $("#interfaceUsername").text(user.details.nickname);

                $( "#noFbBtn" ).click(function() {
                    loadHomepage(false);
                });

                $( "#trainingBtn" ).click(function() {

                    var paramUser = '&email='+user.details.email;
                    var paramPass = '&pass='+user.details.password;

                    window.location.href = '../gtw-game/index.html?'+paramUser+''+paramPass;

                });

                $( "#detailsPanelBtn" ).click(function() {
                    $( "#detailsPanel" ).show();
                    $( "#graphPanel" ).hide();
                    $( "#detailsPanelBtn" ).addClass('tab-btn-active').removeClass('tab-btn-inactive');
                    $( "#graphPanelBtn" ).removeClass('tab-btn-active').addClass('tab-btn-inactive');
                });

                $( "#graphPanelBtn" ).click(function() {
                    $( "#detailsPanel" ).hide();
                    $( "#graphPanel" ).show();
                    $( "#graphPanelBtn" ).addClass('tab-btn-active').removeClass('tab-btn-inactive');
                    $( "#detailsPanelBtn" ).removeClass('tab-btn-active').addClass('tab-btn-inactive');

                    drawChart(calendar);
                });

            });

        } else {
            alert('no user');
        }

    }, function(error) {
        alert(error.code);
        window.location.href = currentUrl;
        return error.code;
    });



    function loadHomepage(fbIsLoggedIn, token) {

        $('#loader').show();

        user.hasFB = fbIsLoggedIn;

        $("#fb-login-section").hide();

        initializationCallback = new MyRequestsCompleted({
            numRequest: 2,
            singleCallback: function() {

                // Authenticate with Social Tracker - Get Collection
                $.ajax({
                    method: "GET",
                    url: "http://augreal.mklab.iti.gr:81/api/collection/"+user.ST.collection,
                    success: function(data) {

                        console.log(user.ST.sources);

                        var refreshDataCallback = new MyRequestsCompleted({
                            numRequest: user.ST.sources,
                            singleCallback: function() {

                                var reference = firebase.database().ref('users/' + currentUser.uid + '/general/dashboardVisits');
                                var ts = Math.floor(Date.now()/1000);
                                var date = String(new Date(ts));

                                reference.child(ts).set({
                                    "date": date
                                });


                                reference = firebase.database().ref('users/' + currentUser.uid);
                                reference.once('value').then(function (snapshot) {

                                    // Calculate training todos
                                    calculateTrainingIndicators(snapshot.val().training.levels);

                                    // Check if there are saved data, to establish boundaries first
                                    console.log("page activity:", snapshot.val().pageActivity);

                                    var gtwStartDate = moment.unix(snapshot.val().general.start[0].timestamp);
                                    var today = moment.utc();

                                    gtwStartDate = gtwStartDate.startOf('day');
                                    today = today.startOf('day');

                                    var yearDiff = today.diff(gtwStartDate, 'years');
                                    var weekDiff = today.diff(gtwStartDate, 'weeks');
                                    var daysDiff = today.diff(gtwStartDate, 'days');
                                    console.log(yearDiff, weekDiff, daysDiff);

                                    var dayTS;
                                    var nextDayTS;
                                    var sessions = [];

                                    sessions = initFirebaseData(sessions, snapshot);

                                    var socialNetworkActivity = !!(snapshot.val().pageActivity.facebook || snapshot.val().pageActivity.twitter || snapshot.val().socialTracker);



                                    for (i=0;i < daysDiff; i++) {

                                        dayTS = gtwStartDate.unix();

                                        calendar.push({
                                            year: gtwStartDate.year(),
                                            month: gtwStartDate.month() + 1, // month starts from 0
                                            monthString: gtwStartDate.format("MMMM"),
                                            week: gtwStartDate.week(),
                                            day: gtwStartDate.date(),
                                            weekDay: gtwStartDate.isoWeekday(),
                                            weekDayString: gtwStartDate.format('dddd'),
                                            ts: dayTS,
                                            email: [], // 1.1
                                            facebook: [], // 1.2
                                            twitter: [], // 1.2
                                            instagram: [], // 1.2
                                            forum: [], // 1.3
                                            youtube: [], // 1.6 & 2.1
                                            news: [], // 1.7 & 2.4
                                            entertainment: [], // 2.1
                                            health: [], // 2.2
                                            elearning: [], // 3.1
                                            linkedin: [], // 3.2
                                            /*work: [], // 3.4*/
                                            job: [] // 3.5

                                        });

                                        gtwStartDate.add(1, 'days');
                                        nextDayTS = gtwStartDate.unix();

                                        // 1.1 E-mail
                                        if (sessions.email) { calendar[calendar.length-1].email = calculateScores('email', sessions.email, dayTS, nextDayTS, calendar[calendar.length-1].email, calendar[calendar.length-2] ? calendar[calendar.length-2].email : null); }

                                        // 1.2 General Social Network activity
                                        // Calculate social networks first
                                        if (sessions.social.facebook) { calendar[calendar.length-1].facebook = calculateScores('facebook', sessions.social.facebook, dayTS, nextDayTS, calendar[calendar.length-1].facebook, calendar[calendar.length-2] ? calendar[calendar.length-2].facebook: null); }
                                        if (sessions.social.twitter) { calendar[calendar.length-1].twitter = calculateScores('twitter', sessions.social.twitter, dayTS, nextDayTS, calendar[calendar.length-1].twitter, calendar[calendar.length-2] ? calendar[calendar.length-2].twitter : null); }
                                        if (sessions.social.instagram) { calendar[calendar.length-1].instagram = calculateScores('instagram', sessions.social.instagram, dayTS, nextDayTS, calendar[calendar.length-1].instagram, calendar[calendar.length-2] ? calendar[calendar.length-2].instagram : null); }

                                        // Now calculate data from social Tracker
                                        if (sessions.social.facebook) {  }
                                        if (sessions.social.twitter) {  }
                                        if (sessions.social.instagram) {  }

                                        if (sessions.forum) { calendar[calendar.length-1].forum = calculateScores('forum', sessions.forum, dayTS, nextDayTS, calendar[calendar.length-1].forum, calendar[calendar.length-2] ? calendar[calendar.length-2].forum : null); }
                                        if (sessions.youtube) { calendar[calendar.length-1].youtube = calculateScores('youtube', sessions.youtube, dayTS, nextDayTS, calendar[calendar.length-1].youtube, calendar[calendar.length-2] ? calendar[calendar.length-2].youtube : null); }
                                        if (sessions.news) { calendar[calendar.length-1].news = calculateScores('news', sessions.news, dayTS, nextDayTS, calendar[calendar.length-1].news, calendar[calendar.length-2] ? calendar[calendar.length-2].news : null); }
                                        if (sessions.entertainment) { calendar[calendar.length-1].entertainment = calculateScores('entertainment', sessions.entertainment, dayTS, nextDayTS, calendar[calendar.length-1].entertainment, calendar[calendar.length-2] ? calendar[calendar.length-2].entertainment : null); }
                                        if (sessions.health) { calendar[calendar.length-1].health = calculateScores('health', sessions.health, dayTS, nextDayTS, calendar[calendar.length-1].health, calendar[calendar.length-2] ? calendar[calendar.length-2].health : null); }
                                        if (sessions.elearning) { calendar[calendar.length-1].elearning = calculateScores('elearning', sessions.elearning, dayTS, nextDayTS, calendar[calendar.length-1].elearning, calendar[calendar.length-2] ? calendar[calendar.length-2].elearning : null); }
                                        if (sessions.linkedin) { calendar[calendar.length-1].linkedin = calculateScores('linkedin', sessions.linkedin, dayTS, nextDayTS, calendar[calendar.length-1].linkedin, calendar[calendar.length-2] ? calendar[calendar.length-2].linkedin : null); }
                                        if (sessions.job) { calendar[calendar.length-1].job = calculateScores('job', sessions.job, dayTS, nextDayTS, calendar[calendar.length-1].job, calendar[calendar.length-2] ? calendar[calendar.length-2].job : null); }

                                        // Time spent online

                                        // Keystrokes

                                    }

                                    // TODO Save to Firebase, last date that the information was calculated
                                    console.log(calendar);

                                    // Score Averages
                                    var averages = [];

                                    var scoreAverage = [];
                                    scoreAverage.participation = 0;
                                    scoreAverage.empowerment = 0;
                                    scoreAverage.education = 0;

                                    for (var k in sessionType) {
                                        if (typeof sessionType[k] !== 'function') {
                                            averages[sessionType[k]] = calculateScoreAverage(calendar, sessionType[k]);
                                        }
                                    }

                                    scoreAverage.participation = (averages.email + averages.facebook + averages.twitter + averages.instagram + averages.forum + averages.youtube + averages.news) / 7;
                                    scoreAverage.empowerment = (averages.youtube + averages.entertainment + averages.news + averages.health) / 4;
                                    scoreAverage.education = (averages.elearning + averages.linkedin + averages.job) / 3;

                                    $("#scoreAverageParticipationIndicator").text(scoreAverage.participation);
                                    $("#scoreAverageEmpowermentIndicator").text(scoreAverage.empowerment);
                                    $("#scoreAverageEducationIndicator").text(scoreAverage.education);


                                    // Total
                                    scoreAverage.total = (scoreAverage.participation + scoreAverage.empowerment + scoreAverage.education)/3;

                                    // Update total score!
                                    var reference = firebase.database().ref('users/' + currentUser.uid);
                                    reference.once('value').then(function () {
                                        firebase.database().ref('users/' + currentUser.uid + '/scores').update({
                                            "total": scoreAverage.total
                                        });

                                        $("#scoreTotalIndicator").text(scoreAverage.total);

                                        // Show page
                                        $('#loader').hide();
                                        $("#homepage-section").show();
                                    });


                                });

                            }
                        });

                        // Owner not found, create owner collection and log everything from this timestamp and onward!
                        // Maybe this will never happen but let's handle it if the user creates a FB account in the future!
                        if (data.count === 0) {

                            alert("Social Tracker Collection not found. Please add a Collection!");

                        } else {

                            var i, socialSource = '';
                            for (i=0; i < data.collections[0].accounts.length; i++) {

                                socialSource = data.collections[0].accounts[i].source;
                                var until = String(Math.floor(Date.now()));
                                var since;

                                console.log(socialSource);

                                // Facebook not applicable, since we don't save FB data on the Social Tracker.
                                switch(socialSource) {

                                    case 'Twitter':

                                        since = String(user.socialTracker.lastUpdated.twTs);
                                        console.log("ST TWITTER Last saved date - now: ", since, until);

                                        $.ajax({
                                            method: "GET",
                                            url: "http://augreal.mklab.iti.gr:81/api/items",
                                            data: {
                                                collection: data.collections[0]._id,
                                                language: 'all',
                                                topics: '*',
                                                unique: false,
                                                original: "all",
                                                type: "all",
                                                source: "Twitter",
                                                sort: "recency",
                                                since: since + '001',
                                                until: until,
                                                nPerPage: 2000,
                                                Page: 1

                                            },
                                            success: function (arr) {

                                                console.log("TW: ", arr);

                                                if (arr.length !== 0) {

                                                    var tweets = createTwitterItems(arr);

                                                    var reference = firebase.database().ref('users/' + currentUser.uid + '/socialTracker/twitter/tweets');
                                                    reference.once('value').then(function (snapshot) {

                                                        // Upload Twitter items
                                                        for (var i in tweets) { reference.child(tweets[i].publicationTime).set(tweets[i]); }

                                                        // Update timestamp!
                                                        firebase.database().ref('users/' + currentUser.uid + '/socialTracker/lastUpdated').update({
                                                            "twTs": tweets[0].publicationTime
                                                        });

                                                        console.log("Twitter Data collection - COMPLETE");

                                                        // Fire callback
                                                        refreshDataCallback.requestComplete(true);
                                                    });

                                                } else { refreshDataCallback.requestComplete(true); }

                                            }, error:function() { alert("Error, Could not get Twitter items");
                                                // Fire callback
                                                refreshDataCallback.requestComplete(true);
                                            }
                                        });



                                        break;
                                    case 'Youtube':
                                        since = String(user.socialTracker.lastUpdated.ytTs);
                                        console.log("ST YOUTUBE Last saved date - now: ", since, until);

                                        $.ajax({
                                            method: "GET",
                                            url: "http://augreal.mklab.iti.gr:81/api/items",
                                            data: {
                                                collection: data.collections[0]._id,
                                                language: 'all',
                                                topics: '*',
                                                unique: false,
                                                original: "all",
                                                type: "all",
                                                source: "Youtube",
                                                sort: "recency",
                                                since: since+'001',
                                                until: until,
                                                nPerPage: 2000,
                                                Page: 1

                                            },
                                            success: function (arr) {

                                                console.log("YT: ", arr);

                                                // Fire callback
                                                refreshDataCallback.requestComplete(true);

                                            }, error:function() { alert("Error, Could not get YT items");
                                                // Fire callback
                                                refreshDataCallback.requestComplete(true);
                                            }
                                        });



                                        break;
                                    case 'GooglePlus':

                                        since = String(user.socialTracker.lastUpdated.gpTs);
                                        console.log("ST GPLUS Last saved date - now: ", since, until);

                                        $.ajax({
                                            method: "GET",
                                            url: "http://augreal.mklab.iti.gr:81/api/items",
                                            data: {
                                                collection: data.collections[0]._id,
                                                language: 'all',
                                                topics: '*',
                                                unique: false,
                                                original: "all",
                                                type: "all",
                                                source: "GooglePlus",
                                                sort: "recency",
                                                since: since+'001',
                                                until: until,
                                                nPerPage: 2000,
                                                Page: 1

                                            },
                                            success: function (arr) {

                                                console.log("GP: ", arr);

                                                if (arr.length !== 0) {

                                                    var gPosts = createGooglePlusItems(arr);

                                                    var reference = firebase.database().ref('users/' + currentUser.uid + '/socialTracker/googlePlus/posts');
                                                    reference.once('value').then(function (snapshot) {

                                                        // Upload Twitter items
                                                        for (var i in gPosts) { reference.child(gPosts[i].publicationTime).set(gPosts[i]); }

                                                        // Update timestamp!
                                                        firebase.database().ref('users/' + currentUser.uid + '/socialTracker/lastUpdated').update({
                                                            "gpTs": gPosts[0].publicationTime
                                                        });

                                                        console.log("GP Data collection - COMPLETE");

                                                        // Fire callback
                                                        refreshDataCallback.requestComplete(true);
                                                    });

                                                } else { refreshDataCallback.requestComplete(true); }


                                            }, error:function() { alert("Error, Could not get G+ items");
                                                // Fire callback
                                                refreshDataCallback.requestComplete(true);
                                            }
                                        });

                                        // Fire callback
                                        refreshDataCallback.requestComplete(true);

                                        break;
                                    default:
                                }
                            }
                        }
                    }, error:function() { alert("Error, Could not load Social Tracker API"); }
                });
            }
        });


        // 1. Authenticate with Firebase
        firebase.auth().signInWithEmailAndPassword(user.details.email, user.details.password).then(function() {

            currentUser = firebase.auth().currentUser;

            if (currentUser !== null) {

                return firebase.database().ref('/users/' + currentUser.uid ).once('value').then(function(snapshot) {

                    // Check if there is ST data saved in Firebase
                    if (snapshot.val().socialTracker) {

                        user.socialTracker.lastUpdated = snapshot.val().socialTracker.lastUpdated;
                        if (!user.socialTracker.lastUpdated.fbTs && !user.hasFB) { user.socialTracker.lastUpdated.fbTs = snapshot.val().general.starts[0].date; }

                    }


                    if (user.hasFB) {

                        // 1a. Get FB user data
                        FB.api('/me', {
                            access_token: token,
                            fields: 'id, name, locale, email, picture, link, friends'

                        }, function(response) {

                            user.FB.userDetails = {
                                email: response.email,
                                name: response.name,
                                avatar: response.picture.data.url,
                                friends: response.friends.summary.total_count,
                                id: response.id,
                                profile: response.link,
                                locale: response.locale
                            };

                            console.log("Got FB user information");

                            // 1b. Get FB user posts
                            FB.api('/me/feed', {
                                access_token: token,
                                since: user.socialTracker.lastUpdated.fbTs,
                                fields: 'name, message, link, likes, shares, comments, created_time, permalink_url, status_type, type, source, picture' // Unused: message_tags
                            }, function(response) { getAllFBPostsRecursive(response); });
                        });

                        function getAllFBPostsRecursive(response) {

                            if (typeof response.paging === "undefined" || typeof response.paging.next === "undefined") {


                                if (user.FB.data.length !== 0) {

                                    // Flatten results to single array
                                    user.FB.data = [].concat.apply([], user.FB.data);
                                    console.log("FB DATA FLAT: ", user.FB.data);

                                    var fbPosts = createFBItems(user.FB.data);

                                    console.log("FB Posts to upload: ", fbPosts);

                                    var reference = firebase.database().ref('users/' + currentUser.uid + '/socialTracker/facebook/posts');
                                    reference.once('value').then(function (snapshot) {

                                        // Upload FB items
                                        for (var i in fbPosts) {
                                            reference.child(fbPosts[i].publicationTime).set(fbPosts[i]);
                                        }

                                        // Update timestamp!
                                        firebase.database().ref('users/' + currentUser.uid + '/socialTracker/lastUpdated').update({
                                            "fbTs": fbPosts[0].publicationTime
                                        });

                                        console.log("FB data collection - COMPLETE");

                                        // Fire callback
                                        initializationCallback.requestComplete(true);
                                    });
                                } else {
                                    // Fire callback
                                    initializationCallback.requestComplete(true);
                                }

                            } else {
                                // Read all data
                                user.FB.data.push(response.data);
                                FB.api(response.paging.next, getAllFBPostsRecursive);

                            }
                        }

                    } else {

                        console.log("Îot FB logged in");

                        // Fire callback - Facebook OFF
                        initializationCallback.requestComplete(true);
                    }

                });

            } else {
                alert("Firebase: Not signed in. Please try again later!");
                return 0;
            }
        });

        // 2. Check ST
        $.ajax({
            method: "GET",
            url: "http://augreal.mklab.iti.gr:81/api/collection/"+user.ST.collection,
            success: function(data) {

                user.ST.sources = data.collections[0].accounts.length;

                // Fire callback 2 - Firebase logged-in
                initializationCallback.requestComplete(true);

            }, error:function() { alert("Error, Could not load Social Tracker API"); }
        });
    }

</script>
<script type="text/javascript" src="js/scripts.js"></script>
</body>
</html>